import pandas as pd

# Load file
experiment_trials = pd.read_excel('conditions_stress.xlsx')

# Create columns if needed
if 'item_id' not in experiment_trials.columns:
    experiment_trials['file_name'] = experiment_trials['sounds'].apply(lambda x: x.split("/")[-1])
    experiment_trials['item_id'] = experiment_trials['file_name'].apply(lambda x: x[:2])
    experiment_trials['cond'] = experiment_trials['file_name'].apply(lambda x: x[2])

# Define how many you want per condition
n_items_per_cond = 10
conditions = ['a', 'b', 'c', 'd']
selected_list = []

# Loop through each condition and do safe sampling
for cond in conditions:
    cond_df = experiment_trials[experiment_trials['cond'] == cond]

    # Get unique item_id entries only
    cond_unique = (
        cond_df
        .groupby('item_id', group_keys=False)
        .apply(lambda x: x.sample(1))
        .reset_index(drop=True)
    )

    if len(cond_unique) < n_items_per_cond:
        raise ValueError(f"Not enough unique items for condition '{cond}': found {len(cond_unique)}, need {n_items_per_cond}.")

    selected = cond_unique.sample(n=n_items_per_cond)
    selected_list.append(selected)

# Combine and shuffle
selected_trials = pd.concat(selected_list).sample(frac=1).reset_index(drop=True)

# Save to file
selected_trials.to_csv('selected_trials.csv', index=False)
