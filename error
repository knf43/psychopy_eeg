import pandas as pd

# Load the file
experiment_trials = pd.read_excel('conditions_stress.xlsx')

# Extract item_id and cond if missing
if 'item_id' not in experiment_trials.columns:
    experiment_trials['file_name'] = experiment_trials['sounds'].apply(lambda x: x.split("/")[-1])
    experiment_trials['item_id'] = experiment_trials['file_name'].apply(lambda x: x[:2])
    experiment_trials['cond'] = experiment_trials['file_name'].apply(lambda x: x[2])

# Desired number of items per condition
n_items_per_cond = 10

# Define the target conditions
target_conditions = ['a', 'b', 'c', 'd']

# Create a list to store selected trials
selected_list = []

# Loop through each condition and sample
for cond in target_conditions:
    cond_items = experiment_trials[experiment_trials['cond'] == cond]

    # Drop duplicate item_ids (keep one version per item_id)
    cond_unique = (
        cond_items
        .groupby('item_id', group_keys=False)
        .apply(lambda x: x.sample(1))
        .reset_index(drop=True)
    )

    # Check if we have enough
    if len(cond_unique) < n_items_per_cond:
        raise ValueError(f"Not enough unique items for condition '{cond}': found {len(cond_unique)}")

    # Sample exactly 10
    selected = cond_unique.sample(n=n_items_per_cond)
    selected_list.append(selected)

# Concatenate and shuffle
selected_trials = pd.concat(selected_list).sample(frac=1).reset_index(drop=True)

# Save
selected_trials.to_csv('selected_trials.csv', index=False)
